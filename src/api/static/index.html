<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSI RAG Pipeline - Real-Time Document Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .document-card {
            transition: all 0.3s ease;
        }
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .live-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .real-time-section {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .hidden {
            display: none !important;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .upload-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i data-feather="database" class="w-8 h-8 text-blue-600 mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">PSI RAG Pipeline</h1>
                    <span class="ml-3 px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">LLM Specialist Assignment</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full live-indicator mr-2" id="live-indicator"></div>
                        <span class="text-sm text-gray-600">Live</span>
                    </div>
                    <button onclick="resetAll()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i data-feather="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                        Reset All
                    </button>
                    <button onclick="refreshAll()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-feather="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Real-Time Statistics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-600 text-white p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100">Total Documents</p>
                        <p class="text-3xl font-bold" id="total-docs">-</p>
                    </div>
                    <i data-feather="file-text" class="w-8 h-8 text-blue-200"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600">Active Documents</p>
                        <p class="text-3xl font-bold text-green-600" id="active-docs">-</p>
                    </div>
                    <i data-feather="check-circle" class="w-8 h-8 text-green-500"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600">Recent Uploads</p>
                        <p class="text-3xl font-bold text-blue-600" id="recent-uploads">-</p>
                    </div>
                    <i data-feather="upload" class="w-8 h-8 text-blue-500"></i>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600">Total Size</p>
                        <p class="text-3xl font-bold text-purple-600" id="total-size">-</p>
                    </div>
                    <i data-feather="hard-drive" class="w-8 h-8 text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Ask Questions -->
            <div class="space-y-6">
                <!-- Ask Questions Section -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i data-feather="help-circle" class="w-5 h-5 mr-2 text-green-600"></i>
                        Ask Questions
                    </h3>
                    <div class="space-y-4">
                        <textarea id="query-input" placeholder="Ask a question about your documents..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="4"></textarea>
                        
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="use-reranking" class="mr-2">
                                <span class="text-sm text-gray-700">Use Advanced Reranking</span>
                            </label>
                            <select id="results-count" class="px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="5">5 Results</option>
                                <option value="10">10 Results</option>
                                <option value="15">15 Results</option>
                            </select>
                        </div>
                        
                        <button onclick="askQuestion()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                            <i data-feather="send" class="w-4 h-4 inline mr-2"></i>
                            Ask Question
                        </button>
                        
                        <!-- Help message when no documents -->
                        <div id="no-docs-help" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800 hidden">
                            <i data-feather="info" class="w-4 h-4 inline mr-2"></i>
                            <strong>No documents found!</strong> Upload some documents first to start asking questions.
                        </div>
                    </div>
                    
                    <div id="query-results" class="mt-6"></div>
                </div>

                <!-- AI Response Section -->
                <div id="ai-response-section" class="bg-white rounded-xl shadow-sm border p-6 hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i data-feather="zap" class="w-5 h-5 mr-2 text-yellow-600"></i>
                        AI Response
                    </h3>
                    <div id="ai-response-content" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <!-- AI response will be displayed here -->
                    </div>
                </div>

                <!-- Query Error Section -->
                <div id="query-error-section" class="bg-white rounded-xl shadow-sm border p-6 hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i data-feather="alert-triangle" class="w-5 h-5 mr-2 text-red-600"></i>
                        Query Error
                    </h3>
                    <div id="query-error-content" class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <!-- Query errors will be displayed here -->
                    </div>
                </div>

                <!-- Source Documents Section -->
                <div id="source-documents-section" class="bg-white rounded-xl shadow-sm border p-6 hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i data-feather="list" class="w-5 h-5 mr-2 text-purple-600"></i>
                        Source Documents
                    </h3>
                    <div id="source-documents-content">
                        <!-- Source documents will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Real-Time Document Management -->
            <div class="space-y-6">
                <!-- Real-Time Document Management -->
                <div class="real-time-section bg-white rounded-xl shadow-sm border p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <i data-feather="activity" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Real-Time Document Management
                    </h3>
                    
                    <!-- File Upload Zone (Simplified) -->
                    <div class="mb-6">
                        <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                            <i data-feather="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-gray-600 text-sm">Click to upload documents (PDF, DOCX, TXT, HTML)</p>
                            <p class="text-gray-500 text-xs mt-1">Supports up to 25 documents, 4MB each</p>
                        </div>
                        <input type="file" id="file-input" multiple class="hidden" accept=".pdf,.docx,.txt,.html">
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex space-x-2">
                            <input type="text" id="search-docs" placeholder="Search documents..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <select id="category-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">All Categories</option>
                                <option value="general">General</option>
                                <option value="technical">Technical</option>
                                <option value="research">Research</option>
                            </select>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span id="doc-count">0</span> documents
                        </div>
                    </div>
                    
                    <div id="documents-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Documents will be loaded here -->
                        <div class="text-center text-gray-500 py-8">
                            <i data-feather="folder" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                            <p>No documents yet</p>
                            <p class="text-sm">Upload files to see them here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebSocket Connection -->
    <script>
        let ws = null;
        let refreshInterval = null;
        let lastRefreshTime = 0;
        const REFRESH_COOLDOWN = 3000; // 3 seconds between refreshes (faster updates)
        
        // Initialize WebSocket connection
        function initWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/documents`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    updateConnectionStatus(true);
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onclose = function(event) {
                    console.log('WebSocket disconnected:', event.code, event.reason);
                    updateConnectionStatus(false);
                    
                    // Don't auto-reconnect if it's a 403 Forbidden (rate limited)
                    if (event.code === 1006 || event.code === 1000) {
                        // Normal closure or abnormal closure - try to reconnect
                        setTimeout(initWebSocket, 10000); // Wait 10 seconds
                    } else if (event.code === 1008) {
                        // Policy violation (like rate limiting) - wait longer
                        setTimeout(initWebSocket, 30000); // Wait 30 seconds
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('Failed to initialize WebSocket:', error);
                updateConnectionStatus(false);
            }
        }
        
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'initial_stats':
                    updateStats(data.stats);
                    break;
                case 'document_added':
                    showNotification('Document added: ' + data.document.filename, 'success');
                    safeRefresh();
                    break;
                case 'document_deleted':
                    showNotification('Document deleted', 'info');
                    safeRefresh();
                    break;
                case 'document_updated':
                    showNotification('Document updated: ' + data.document.filename, 'success');
                    safeRefresh();
                    break;
                case 'system_reset':
                    showNotification('System reset completed', 'info');
                    safeRefresh();
                    break;
            }
        }
        
        function safeRefresh() {
            const now = Date.now();
            if (now - lastRefreshTime > REFRESH_COOLDOWN) {
                lastRefreshTime = now;
                refreshStats();
                loadDocuments();
            }
        }
        
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('live-indicator');
            if (connected) {
                indicator.classList.remove('bg-red-500');
                indicator.classList.add('bg-green-500');
            } else {
                indicator.classList.remove('bg-green-500');
                indicator.classList.add('bg-red-500');
            }
        }
        
        // File upload handling with drag and drop
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        
        // Drag and drop events
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });
        
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });
        
        async function uploadFiles(files) {
            // Check file count limit (25 documents)
            if (files.length > 25) {
                showNotification('Maximum 25 documents allowed at once', 'error');
                return;
            }
            
            // Check individual file size (4MB limit)
            const maxSize = 4 * 1024 * 1024; // 4MB
            for (let file of files) {
                if (file.size > maxSize) {
                    showNotification(`File ${file.name} is too large. Maximum size is 4MB.`, 'error');
                    return;
                }
            }
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            
            // Add metadata
            formData.append('metadata', JSON.stringify({
                tags: [],
                category: 'general'
            }));
            
            showUploadProgress();
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Successfully uploaded ${files.length} documents!`, 'success');
                    safeRefresh();
                } else {
                    showNotification('Upload failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Upload failed: ' + error.message, 'error');
            } finally {
                hideUploadProgress();
                // Clear file input
                fileInput.value = '';
            }
        }
        
        function showUploadProgress() {
            // Show a simple progress indicator
            uploadZone.innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="ml-2 text-blue-600">Uploading...</span>
                </div>
            `;
        }
        
        function hideUploadProgress() {
            // Restore upload zone
            uploadZone.innerHTML = `
                <i data-feather="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                <p class="text-gray-600 text-sm">Click to upload documents (PDF, DOCX, TXT, HTML)</p>
                <p class="text-gray-500 text-xs mt-1">Supports up to 25 documents, 4MB each</p>
            `;
            feather.replace();
        }
        
        // Document management with real-time updates
        async function loadDocuments() {
            try {
                const response = await fetch('/documents/list');
                
                if (response.status === 429) {
                    console.log('Rate limited, skipping document load');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayDocuments(result.documents || []);
                    updateDocumentCount(result.documents ? result.documents.length : 0);
                } else {
                    console.error('Failed to load documents:', result.error);
                    displayDocuments([]);
                    updateDocumentCount(0);
                }
            } catch (error) {
                console.error('Failed to load documents:', error);
                displayDocuments([]);
                updateDocumentCount(0);
            }
        }
        
        function updateDocumentCount(count) {
            document.getElementById('doc-count').textContent = count;
            
            // Show/hide help message based on document count
            const noDocsHelp = document.getElementById('no-docs-help');
            if (count === 0) {
                noDocsHelp.classList.remove('hidden');
            } else {
                noDocsHelp.classList.add('hidden');
            }
        }
        
        function displayDocuments(documents) {
            const container = document.getElementById('documents-list');
            
            if (!documents || documents.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i data-feather="folder" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>No documents yet</p>
                        <p class="text-sm">Upload files to see them here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = documents.map(doc => createDocumentCard(doc)).join('');
            feather.replace();
        }
        
        function createDocumentCard(doc) {
            const size = formatFileSize(doc.file_size || 0);
            const uploadDate = doc.upload_time ? new Date(doc.upload_time).toLocaleDateString() : 'Unknown';
            const category = doc.category || 'general';
            const tags = doc.tags || [];
            
            return `
                <div class="document-card bg-white p-4 rounded-lg border hover:shadow-md">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-900 text-sm truncate" title="${doc.filename || 'Unknown'}">${doc.filename || 'Unknown'}</h4>
                            <p class="text-xs text-gray-600">Size: ${size}</p>
                            <p class="text-xs text-gray-600">Uploaded: ${uploadDate}</p>
                            <p class="text-xs text-gray-600">Category: ${category}</p>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button onclick="deleteDocument('${doc.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded text-xs" title="Delete">
                                <i data-feather="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${tags.map(tag => `<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }
        
        async function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }
            
            try {
                const response = await fetch(`/documents/${docId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Document deleted successfully!', 'success');
                    safeRefresh();
                } else {
                    showNotification('Failed to delete document: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('Failed to delete document: ' + error.message, 'error');
            }
        }
        
        // Query handling
        async function askQuestion() {
            const question = document.getElementById('query-input').value.trim();
            if (!question) {
                showNotification('Please enter a question', 'error');
                return;
            }
            
            const useReranking = document.getElementById('use-reranking').checked;
            const resultsCount = document.getElementById('results-count').value;
            
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        use_reranking: useReranking,
                        n_results: parseInt(resultsCount)
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.detail || `HTTP ${response.status}: ${response.statusText}`;
                    showNotification('Query failed: ' + errorMessage, 'error');
                    
                    // Show detailed error in the error section
                    document.getElementById('query-error-section').classList.remove('hidden');
                    document.getElementById('query-error-content').innerHTML = `
                        <div class="text-red-800">
                            <p class="font-medium">Query Failed</p>
                            <p class="text-sm mt-1">Error: ${errorMessage}</p>
                            <p class="text-sm mt-1">Status: ${response.status} ${response.statusText}</p>
                            <p class="text-sm mt-2 text-red-600">This usually means there are no documents in the system to search, or the documents haven't been processed yet.</p>
                        </div>
                    `;
                    
                    // Hide other sections
                    document.getElementById('ai-response-section').classList.add('hidden');
                    document.getElementById('source-documents-section').classList.add('hidden');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayQueryResults(result);
                } else {
                    showNotification('Query failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Query error:', error);
                showNotification('Query failed: ' + error.message, 'error');
            }
        }
        
        function displayQueryResults(result) {
            // Show AI Response section
            document.getElementById('ai-response-section').classList.remove('hidden');
            document.getElementById('ai-response-content').innerHTML = `
                <p class="text-gray-900">${result.answer}</p>
                <div class="mt-3 text-sm text-gray-600">
                    <p>Processing time: ${result.processing_time}s</p>
                    <p>Documents retrieved: ${result.sources ? result.sources.length : 0}</p>
                </div>
            `;
            
            // Show Source Documents section
            if (result.sources && result.sources.length > 0) {
                document.getElementById('source-documents-section').classList.remove('hidden');
                const sourcesHtml = result.sources.map((source, index) => `
                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-sm text-gray-600">Source ${index + 1}</p>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Similarity: ${(source.similarity * 100).toFixed(1)}%</p>
                                <p class="text-sm text-gray-600">Rank: ${index + 1}</p>
                            </div>
                        </div>
                        <p class="text-gray-900 text-sm">${source.content}</p>
                        <p class="text-xs text-gray-500 mt-2">File: ${source.metadata?.file_name || 'Unknown'} | Format: ${source.metadata?.file_type || 'Unknown'}</p>
                    </div>
                `).join('');
                
                document.getElementById('source-documents-content').innerHTML = sourcesHtml;
            }
        }
        
        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        async function refreshStats() {
            try {
                // Refresh real-time stats
                const response = await fetch('/documents/stats/realtime');
                
                if (response.status === 429) {
                    console.log('Rate limited, skipping stats refresh');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateStats(result.stats);
                }
                
            } catch (error) {
                console.error('Failed to refresh stats:', error);
            }
        }
        
        function updateStats(stats) {
            if (!stats) return;
            
            document.getElementById('total-docs').textContent = stats.total_documents || 0;
            document.getElementById('active-docs').textContent = stats.active_documents || 0;
            document.getElementById('recent-uploads').textContent = stats.recent_uploads || 0;
            document.getElementById('total-size').textContent = formatFileSize(stats.total_size || 0);
        }
        
        function refreshAll() {
            refreshStats();
            loadDocuments();
        }
        
        async function resetAll() {
            if (confirm('Are you sure you want to reset all documents? This will remove all uploaded files.')) {
                try {
                    // Clear all documents by calling the backend reset endpoint
                    const response = await fetch('/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('System reset successfully!', 'success');
                        // Clear the UI
                        document.getElementById('total-docs').textContent = '0';
                        document.getElementById('active-docs').textContent = '0';
                        document.getElementById('recent-uploads').textContent = '0';
                        document.getElementById('total-size').textContent = '0 B';
                        
                        // Clear document list
                        document.getElementById('documents-list').innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <i data-feather="folder" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                                <p>No documents yet</p>
                                <p class="text-sm">Upload files to see them here</p>
                            </div>
                        `;
                        
                        updateDocumentCount(0);
                        feather.replace();
                    } else {
                        showNotification('Reset failed: ' + result.error, 'error');
                    }
                } catch (error) {
                    showNotification('Reset failed: ' + error.message, 'error');
                }
            }
        }
        
        // Search and filter functionality
        function filterDocuments(searchTerm) {
            const documentCards = document.querySelectorAll('.document-card');
            documentCards.forEach(card => {
                const filename = card.querySelector('h4').textContent.toLowerCase();
                const tags = Array.from(card.querySelectorAll('.px-2')).map(tag => tag.textContent.toLowerCase());
                
                if (filename.includes(searchTerm) || tags.some(tag => tag.includes(searchTerm))) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function filterDocumentsByCategory(category) {
            if (!category) {
                // Show all documents
                document.querySelectorAll('.document-card').forEach(card => {
                    card.style.display = 'block';
                });
                return;
            }
            
            document.querySelectorAll('.document-card').forEach(card => {
                const docCategory = card.querySelector('.text-xs.text-gray-600:last-child').textContent.split(': ')[1];
                if (docCategory === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            refreshStats();
            loadDocuments();
            feather.replace();
            
            // Add search functionality
            document.getElementById('search-docs').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterDocuments(searchTerm);
            });
            
            // Add category filter functionality
            document.getElementById('category-filter').addEventListener('change', function(e) {
                const category = e.target.value;
                filterDocumentsByCategory(category);
            });
            
            // Auto-refresh every 30 seconds for real-time updates (reduced frequency)
            refreshInterval = setInterval(refreshStats, 30000);
            
            // Auto-refresh documents every 60 seconds (reduced frequency)
            setInterval(loadDocuments, 60000);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
